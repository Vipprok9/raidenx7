<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>RaidenX7 Â· Trendy Web</title>
  <style>
    :root{--bg:#0f1115;--fg:#e7e7e7;--line:#252a31;--me:#2b87ff;--them:#2a2a2a}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:#1a1f26;padding:12px 16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.2);z-index:5}
    .toggle{position:absolute;right:12px;top:10px;cursor:pointer}
    .gallery{display:flex;gap:10px;overflow-x:auto;padding:12px;border-bottom:1px solid var(--line)}
    .gallery img{height:120px;border-radius:12px;object-fit:cover}
    #chatbox{height:52vh;min-height:280px;padding:12px;overflow-y:auto;position:relative}
    #status{position:absolute;right:8px;top:8px;font-size:11px;opacity:.7}
    ul{list-style:none;padding:0;margin:0}
    li{display:flex;margin:6px 0}
    .me{justify-content:flex-end}
    .them{justify-content:flex-start}
    .bubble{max-width:72%;padding:8px 12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .me .bubble{background:var(--me);color:#fff}
    .them .bubble{background:var(--them);color:var(--fg)}
    .meta{display:block;font-size:11px;opacity:.7;margin-top:4px}
    form{position:sticky;bottom:0;display:flex;gap:8px;padding:12px;border-top:1px solid var(--line);background:var(--bg)}
    input[type=text]{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--fg)}
    button{padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:#2b7cff;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    footer{padding:10px;text-align:center;opacity:.7;border-top:1px solid var(--line)}
  </style>
</head>
<body>
  <header>
    <strong>RaidenX7 Â· Trendy Web</strong>
    <span class="toggle" id="themeToggle" title="Dark/Light">ðŸŒ“</span>
  </header>

  <section class="gallery">
    <img src="assets/img1.jpg" alt="áº¢nh 1">
    <img src="assets/img2.jpg" alt="áº¢nh 2">
    <img src="assets/img3.jpg" alt="áº¢nh 3">
    <img src="assets/img4.jpg" alt="áº¢nh 4 (rá»™ng)">
  </section>

  <section id="chatbox">
    <div id="status">status: initâ€¦</div>
    <ul id="chat"></ul>
  </section>

  <form id="composer" autocomplete="off">
    <input id="message" type="text" placeholder="Nháº­p tin nháº¯n..." />
    <button id="sendBtn" type="submit">Gá»­i</button>
  </form>

  <footer>
    Â© RaidenX7 Â· Build on Cloudflare Pages Ã— Render <br>
    âš¡ Updated v0.4 (SSE + Poll 1s fallback)
  </footer>

  <script>
    // === API_BASE trá» vÃ o backend Render ===
    const API_BASE = "https://raidenx7-bot.onrender.com";

    // Dark/Light
    const root = document.body;
    document.getElementById("themeToggle").onclick = ()=> root.classList.toggle("light");

    // Chat
    const chat = document.getElementById("chat");
    const input = document.getElementById("message");
    const form = document.getElementById("composer");
    const statusEl = document.getElementById("status");
    const renderedIds = new Set();
    function scrollToBottom(){document.getElementById("chatbox").scrollTop=chat.scrollHeight}
    function setStatus(s){statusEl.textContent = s;}

    function appendMessage({id,text,from="me",pending=false}){
      if(id && renderedIds.has(id)) return;
      const li=document.createElement("li");
      li.className=from==="me"?"me":"them";
      if(id) li.dataset.id=id;
      li.innerHTML=`<div class="bubble">
        <span class="t"></span>
        <small class="meta">${pending?"Ä‘ang gá»­iâ€¦":""}</small>
      </div>`;
      li.querySelector(".t").textContent=(from==="me"?"Me":"Telegram")+": "+text;
      chat.appendChild(li);
      if(id) renderedIds.add(id);
      scrollToBottom();
    }

    function markSent(tempId){
      const meta=chat.querySelector(\`li[data-id="\${tempId}"] .meta\`);
      if(meta){meta.textContent="Ä‘Ã£ gá»­i";setTimeout(()=>meta.textContent="",1000)}
    }

    // Gá»­i: hiá»ƒn thá»‹ ngay
    form.addEventListener("submit",e=>{
      e.preventDefault();
      const text=input.value.trim();
      if(!text) return;
      const tempId="tmp_"+Date.now();
      appendMessage({id:tempId,text,from:"me",pending:true});
      input.value="";input.focus();
      fetch(API_BASE+"/send",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text})
      }).then(()=>markSent(tempId)).catch(()=>{});
    });

    // SSE realtime + fallback poll 1s
    let es;
    function startSSE(){
      try{
        es = new EventSource(API_BASE + "/stream");
        es.onopen  = () => setStatus("status: SSE connected");
        es.onmessage = (e)=>{
          try{
            const m = JSON.parse(e.data);
            if(!chat.querySelector(\`li[data-id="\${m.id}"]\`)){
              appendMessage({id:m.id,text:m.text,from:m.from==="them"?"them":"me"});
            }
          }catch{}
        };
        es.onerror = ()=>{
          setStatus("status: SSE error â†’ fallback poll");
          es && es.close();
          startPoll();
        };
      }catch{
        setStatus("status: SSE not supported â†’ fallback poll");
        startPoll();
      }
    }

    let pollTimer=null;
    async function fetchEvents(){
      try{
        const res=await fetch(API_BASE+"/events?ts="+Date.now(),{
          cache:"no-store",headers:{"Cache-Control":"no-cache"}
        });
        if(!res.ok) return;
        const data=await res.json();
        if(Array.isArray(data)){
          data.forEach(m=>{
            if(!chat.querySelector(\`li[data-id="\${m.id}"]\`)){
              appendMessage({id:m.id,text:m.text,from:"them"});
            }
          });
        }
        setStatus("status: polling 1s");
      }catch{
        setStatus("status: polling error");
      }
    }
    function startPoll(){
      if(pollTimer) return;
      fetchEvents();
      pollTimer = setInterval(fetchEvents, 1000);
      document.addEventListener("visibilitychange",()=>{ if(!document.hidden) fetchEvents(); });
    }

    startSSE();
  </script>
</body>
</html>
